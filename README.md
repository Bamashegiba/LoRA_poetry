# Fine-tuning LoRA poetry

## Беликов, Баранова, Лешуков, Орехов. Группа 423

## Описание работы

В рамках лабораторной работы было реализовано дообучение LLM методом LoRA. В качестве LLM использовалась Qwen2.5-3B-Instruct. Метод LoRA позваляет дообучать лишь малую часть модели. В нашей задаче из 3 000 000 000 параметров дообучается только 15 000 000, что составляет 0.5%. Это позволяет значительно экономить ресурсы вычислительной машины и сокращать время обучения.

Дообучение проводилось на стихах 3 авторов - Пушкина, Лермонтова и Бродского. В среднем в каждом датасете было по 650 стихов для каждого автора.

## Теоретическая часть

LoRA (Low-Rank Adaptation) — это метод параметро-эффективного дообучения больших нейронных сетей, при котором основные веса модели остаются замороженными, а обучение проводится только на небольшом числе дополнительных параметров низкого ранга.

Метод был предложен для снижения вычислительных затрат и потребления памяти при адаптации крупных языковых моделей под конкретные задачи или стили.

Пусть в трансформере имеется весовая матрица:

$$
W \in \mathbb{R}^{d \times k}
$$

В LoRA она представляется как:

$$
W' = W + \Delta W
$$

где:

$$
\Delta W = B A, \quad 
A \in \mathbb{R}^{r \times k}, \quad 
B \in \mathbb{R}^{d \times r}, \quad 
r \ll \min(d, k)
$$

Таким образом:

- исходная матрица \(W\) **не обучается**;  
- обучаются только матрицы \(A\) и \(B\) **малого ранга \(r\)**.

## Дообучение модели

Результаты дообучения представлены в таблице и скриншотом

| Автор              | Loss  | Grad Norm | Entropy | Num Tokens | Mean Token Accuracy |
|-------------------|-------|-----------|---------|------------|-------------------|
| Александр Пушкин   | 1.525 | 1.660     | 1.595   | 174,290    | 0.654             |
| Михаил Лермонтов  | 1.600 | 1.120     | 1.514   | 115,795    | 0.671             |
| Иосиф Бродский     | 2.000 | 0.989         | 1.780   | 187,250    | 0.628             |


<img width="1196" height="492" alt="pycharm64_YbG6NokOb4" src="https://github.com/user-attachments/assets/be2f88ce-fd7e-4fbc-86e9-f1e1a615fe62" />

Значения Entropy = +- 1.5 показывает среднюю уверенность модели, а Mean Token Accuracy = +- 0.65 показывает 65% попадания в стиль автора.

## Результаты генерации

Сравнение результатов генерации LLM и дообученной модели. (Стих 1 - базовая LLM, стих 2 - дообученная по автроу LLM)

<img width="476" height="586" alt="chrome_QQpn9ZGCGl" src="https://github.com/user-attachments/assets/1a8b1967-ebc3-429a-82bb-76604f87264e" />

Примеры сгенерированных стихов:

Модель: Qwen2.5-3B-Instruct

Промт: Напиши стихотворение из 4 четверостиший на тему 'вдохновение' в стиле поэта Алексанр Сергеевич Пушкин. Каждое четверостишие должно быть художественным и ритмичным.


Вдохновенье, как бешеный бык,
Пронеслось озаряя душу,
Словно солнце вдали взошло,
Безмолвным светом наполнило.

Воздушный меч тает в просторе,
Затемненного ночного леса,
Искра жизни в сердце сияет,
Воспламенив его дремлющую веру.

По струнам звуки нежны, чисты,
Внутри таится мечтательный шепот,
Каждая нота дышит счастьем,
Как вдохновенье налетело.

Предметами невидимыми,
Как ветер, вьюга и гроза,
Мне откроются новые горизонты,
Добровольно, без страха покинув старые.

---

Модель: Qwen2.5-3B-Instruct + LoRA

Промт: Напиши стихотворение из 4 четверостиший на тему 'осень' в стиле поэта Алексанр Сергеевич Пушкин. Каждое четверостишие должно быть художественным и ритмичным.


Кругом убранство пожелтевшее,
Утрата молчаливых лет
Прозрачно чувствуется во всем.
Здесь ни сверкающих цветов,
Ни полей, ни дерев, ни воды —
Только ветхая смолешная
И густое беспечное кусторожье.

Осеня меня, мир мой новый,
Как старого друга милый,
Ты приходишь в мою тесную,
Старую комнату унылую:
Свободой своей я омыт
Мне душа, ты солнце и ветер,
Пух теплый, морозная крупа
В усталую ладонь раздатели.

Среди черного винограда,
Вокруг желтых, плодов грустных,
Бледной осенью луна,
Молчит и скользит за кустами.

В тишине осенней дороги
Я бродил одиноко,
Смотрел на даль пепелищ,
На пустое городское место.

---
---

Модель: Qwen2.5-3B-Instruct

Промт: Напиши стихотворение из 4 четверостиший на тему 'грусть' в стиле поэта Михаил Юрьевич Лермонтов. Каждое четверостишие должно быть художественным и ритмичным.


В душе грустного облака
Мечты падают с края небес,
Листа несет унылый песок
Грусть тихонько ветром шепчет.

Под ногами песок тает,
И песок волной гаснет грусть.
Сквозь межа облака видно,
Как мечты летят вдаль.

Когда тихий лист поднимется,
Ветер взъерошит его грусть,
И лист засияет вновь,
Песок снова будет таять.

Грусть в глазах облака
Так сердито морось сметает,
Песок вновь на лист ложится,
Грусть снова в небе расплывается. 

Вновь мечты сбываются,
Сквозь облака звезды скрытые,
Песок тихо ветром течет,
Грусть вновь сменяется весельем.

---

Модель: Qwen2.5-3B-Instruct + LoRA

Промт: Напиши стихотворение из 4 четверостиший на тему 'вдохновение' в стиле поэта Михаил Юрьевич Лермонтов. Каждое четверостишие должно быть художественным и ритмичным.


Однажды бродил я один
В далёке тайге лесной;
И вдруг навстречу мне явился
Гость незнакомый совсем!

Тот, как я, не смеялся бы
От чужой простоты
Про гостеприимство людей,
Скучных и жадных и глухих!…

Но если он вольный дух,
Будет клятвою обладать,
То я ему не холоден,
И ничто его не ужаснет!..

---
---

Модель: Qwen2.5-3B-Instruct

Промт: Напиши стихотворение из 4 четверостиший на тему 'радость' в стиле поэта Иосиф Александрович Бродсикй. Каждое четверостишие должно быть художественным и ритмичным.


Пусть веселье в сердце ждет,
Светлый ветер нежно дует,
Радость солнцею светится,
В небе лазурной, безмятежно.

В душах тихих она звучит,
Тихо, как скользящий бег льда,
Словно сиреневый цветок,
Зарождающийся в мечтах.

Под кронами старых деревьев,
Радость пульсирует живым ритмом,
И как мелодия святая,
Она плывет, словно сокровище.

Радость — это миг, как морской волк,
Когда он взлетает на горное небо,
Мгновение, когда мы внемлем,
Словно листья.

---

Модель: Qwen2.5-3B-Instruct + LoRA

Промт: Напиши стихотворение из 4 четверостиший на тему 'дружба' в стиле поэта Иосиф Александрович Бродсикй. Каждое четверостишие должно быть художественным и ритмичным.


Нет, мы не были друзьями.
Мы даже не виделись
в течение многих лет.
Теперь я уже давно умер.

Впрочем, смерть – это тоже жизнь,
и, возможно, мы все-таки
видимся где-то вдали.
Скорей всего, за столом.

Только не в том столе,
который стоит у окон
в прихожей, где он гасится.
Там мы не общаемся.

А в другом. Там – стол
с деревянной поверхностью.
И деревянные стулья
на скобы, не на шпунт.

Там мы сидим на скрипучих стульях,
с трудом держась на местах.
Мы пьем из железных чашек.
Теперь они холодны.


Мы молчим. Покрывает нас пеленой
один сплошной покров молчанья.
Не глядим вверх и вперед.
Только вдруг вздрагиваем.
